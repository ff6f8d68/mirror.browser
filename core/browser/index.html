<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon.png" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror Browser</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="browser">
        <header>
            <div class="url-bar">
                <button id="back-button">&#9664;</button>
                <button id="forward-button">&#9654;</button>
                <input type="text" id="url-input" placeholder="Enter URL">
                <button id="go-button">Go</button>
                <button id="settings-button">&#9881;</button>
            </div>
            <div class="tabs">
                <!-- Home Tab -->
                <div class="tab active" data-url="home.html">
                    <span class="tab-title">Home</span>
                    <button class="close-btn" title="Close Tab">&times;</button>
                </div>
                <!-- Other Tabs -->
                <button id="new-tab-button">+</button>
            </div>
        </header>
        <div class="content">
            <div class="tab-content">
                <iframe id="browser-frame" src="https://mirror-browser.netlify.app/page/?url=https://www.google.com/webhp?igu=1" frameborder="0"></iframe>
            </div>
        </div>
        <div class="settings-menu hidden" id="settings-menu">
            <h2>Settings</h2>
            <label>
                <input type="checkbox" id="dark-mode"> Dark Mode
            </label>
            <button id="close-settings">Close</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('url-input');
            const goButton = document.getElementById('go-button');
            const backButton = document.getElementById('back-button');
            const forwardButton = document.getElementById('forward-button');
            const settingsButton = document.getElementById('settings-button');
            const settingsMenu = document.getElementById('settings-menu');
            const closeSettingsButton = document.getElementById('close-settings');
            const darkModeCheckbox = document.getElementById('dark-mode');
            const newTabButton = document.getElementById('new-tab-button');
            const tabsContainer = document.querySelector('.tabs');
            const frame = document.querySelector('#browser-frame');

            // Default URL
            const defaultURL = 'https://mirror-browser.netlify.app/page/?url=https://www.google.com/webhp?igu=1';

            function createNewTab(url = defaultURL) {
                const tabCount = tabsContainer.querySelectorAll('.tab').length;
                const newTab = document.createElement('div');
                newTab.className = 'tab';
                newTab.innerHTML = `
                    <span class="tab-title">Tab ${tabCount + 1}</span>
                    <button class="close-btn" title="Close Tab">&times;</button>
                `;
                newTab.setAttribute('data-url', url);
                newTab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    newTab.classList.add('active');
                    frame.src = url;
                    urlInput.value = url;
                });

                const closeButton = newTab.querySelector('.close-btn');
                closeButton.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent tab click event
                    if (tabsContainer.querySelectorAll('.tab').length > 1) {
                        const isActiveTab = newTab.classList.contains('active');
                        newTab.remove();
                        if (isActiveTab) {
                            const remainingTabs = tabsContainer.querySelectorAll('.tab');
                            if (remainingTabs.length > 0) {
                                remainingTabs[0].click(); // Click the first tab if the active tab was closed
                            }
                        }
                    } else {
                        alert("You cannot close the last remaining tab.");
                    }
                });

                tabsContainer.insertBefore(newTab, newTabButton);
                newTab.click();
            }

            createNewTab();

            function prependProtocol(url) {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    return 'https://' + url;
                }
                return url;
            }

            function navigateToUrl() {
                let url = urlInput.value.trim();
                if (url) {
                    url = prependProtocol(url);
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab) {
                        const newUrl = `https://mirror-browser.netlify.app/page/?url=${encodeURIComponent(url)}`;
                        frame.src = newUrl;
                        activeTab.setAttribute('data-url', newUrl);
                    } else {
                        frame.src = `https://mirror-browser.netlify.app/page/?url=${encodeURIComponent(url)}`;
                    }
                }
            }

            goButton.addEventListener('click', navigateToUrl);

            urlInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    navigateToUrl();
                    event.preventDefault(); // Prevent the default action to avoid form submission
                }
            });

            urlInput.addEventListener('click', function() {
                urlInput.select(); // Select all text in the input field
            });

            backButton.addEventListener('click', function() {
                document.querySelector('#browser-frame').contentWindow.history.back();
            });

            forwardButton.addEventListener('click', function() {
                document.querySelector('#browser-frame').contentWindow.history.forward();
            });

            settingsButton.addEventListener('click', function() {
                settingsMenu.classList.toggle('hidden');
            });

            closeSettingsButton.addEventListener('click', function() {
                settingsMenu.classList.add('hidden');
            });

            darkModeCheckbox.addEventListener('change', function() {
                document.body.classList.toggle('dark-mode', darkModeCheckbox.checked);
            });

            newTabButton.addEventListener('click', function() {
                createNewTab();
            });

            tabsContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('tab')) {
                    const url = event.target.getAttribute('data-url');
                    if (url) {
                        frame.src = url;
                        urlInput.value = url;
                    }
                }
            });

            frame.addEventListener('load', function() {
                const currentUrl = frame.contentWindow.location.href;
                urlInput.value = currentUrl;
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const urlParams = new URLSearchParams(new URL(currentUrl).search);
                    const title = urlParams.get('title') || 'Untitled';
                    const icon = urlParams.get('icon') || '';
                    activeTab.querySelector('.tab-title').textContent = title;

                    // Update favicon for the active tab
                    let favicon = document.querySelector(`link[rel="icon"]`);
                    if (favicon) {
                        favicon.href = icon;
                    } else {
                        favicon = document.createElement('link');
                        favicon.rel = 'icon';
                        favicon.href = icon;
                        document.head.appendChild(favicon);
                    }
                }
            });

            function updateIframeLinks() {
                const frameDocument = frame.contentDocument || frame.contentWindow.document;
                const script = document.createElement('script');
                script.textContent = `
                    document.addEventListener('click', function(event) {
                        if (event.target.tagName === 'A' && event.target.href) {
                            event.preventDefault();
                            const url = event.target.href;
                            window.top.document.querySelector('#browser-frame').src = 'https://mirror-browser.netlify.app/page/?url=' + encodeURIComponent(url);
                        }
                    }, true);
                `;
                frameDocument.head.appendChild(script);
            }

            frame.addEventListener('load', updateIframeLinks);
        });
    </script>
</body>
</html>
